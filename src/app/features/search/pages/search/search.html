<div class="w-full max-w-5xl mx-auto bg-white dark:bg-gray-900 shadow-xl rounded-2xl p-10 min-h-[60vh]">
  <h1 class="text-2xl font-bold text-gray-800 dark:text-white mb-6">Busqueda</h1>

  <!-- <form class="space-y-4 w-full">
    <div>
      <label for="termino" class="block text-sm font-medium text-gray-700 dark:text-gray-300">
        Ingrese DNI
      </label>
      <input id="termino" type="text" [(ngModel)]="terminoBusqueda" name="termino"
        class="mt-1 block w-full px-4 py-2 border border-gray-300 dark:border-gray-700 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500 dark:bg-gray-800 dark:text-white"
        placeholder="Escribe el número de documento..." />
    </div>

    <div class="flex justify-end">
      <button type="button" (click)="buscar()"
        class=" bg-[#205eaa] text-white px-4 py-2 rounded-md hover:bg-[#307FDE] transition-all">
        Buscar
      </button>
    </div>
  </form> -->


  
<!-- <form class="space-y-4 w-full">
  <label for="termino" class="block text-sm font-medium text-gray-700 dark:text-gray-300">
    Ingrese DNI
  </label>

  <div class="flex gap-2">
    <input
      id="termino"
      type="text"
      [(ngModel)]="terminoBusqueda"
      (ngModelChange)="terminoBusqueda = $event.trim()"
      name="termino"
      class="flex-1 px-4 py-2 border border-gray-300 dark:border-gray-700 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500 dark:bg-gray-800 dark:text-white"
      placeholder="Escribe el número de documento..."
    />

    <button
      type="button"
      (click)="buscar()"
      class="bg-[#205eaa] text-white px-4 py-2 rounded-md hover:bg-[#307FDE] transition-all"
    >
      Buscar
    </button>
  </div>
</form> -->


<form class="space-y-4 w-full">
  <label for="termino" class="block text-sm font-medium text-gray-700 dark:text-gray-300">
    Busque por documento
  </label>

  <div class="flex gap-2">
    <select
      [(ngModel)]="tipoDocumento"
      name="tipoDocumento"
      class="px-4 py-2 border border-gray-300 dark:border-gray-700 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500 dark:bg-gray-800 dark:text-white"
    >
      <option value="1">DNI</option>
      <option value="4">Carnet de Extranjería</option>
      <option value="6">RUC</option>
      <option value="7">Pasaporte</option>
    </select>

    <input
      id="termino"
      type="text"
      [(ngModel)]="terminoBusqueda"
      name="termino"
      class="flex-1 px-4 py-2 border border-gray-300 dark:border-gray-700 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500 dark:bg-gray-800 dark:text-white"
      placeholder="Ingrese el número de documento..."
    />

    <button
      type="button"
      (click)="buscar()"
      class="bg-[#205eaa] text-white px-4 py-2 rounded-md hover:bg-[#307FDE] transition-all"
    >
      Buscar
    </button>
  </div>
</form>

<!-- Botón de descarga Excel alineado a la izquierda y con separación -->
<div *ngIf="resultados.length > 0" class="flex justify-start mt-6 mb-4">
  <button
    (click)="descargarResultadosExcel()"
    class="inline-flex items-center gap-2 bg-green-600 hover:bg-green-700 text-white font-medium py-2 px-4 rounded-md shadow transition-all duration-200"
  >
    <svg class="w-5 h-5" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"
      xmlns="http://www.w3.org/2000/svg">
      <path stroke-linecap="round" stroke-linejoin="round"
        d="M4 4h16v16H4V4zm4 4h8m-8 4h4m-4 4h8" />
    </svg>
    Descargar Excel
  </button>
</div>


  <div *ngIf="cargando" class="mt-6 text-[#307FDE] dark:text-blue-400 font-semibold flex items-center space-x-2">
    <svg class="animate-spin h-5 w-5 text-[#307FDE] dark:text-blue-400" xmlns="http://www.w3.org/2000/svg" fill="none"
      viewBox="0 0 24 24">
      <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
      <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8v8z"></path>
    </svg>
    <span>Cargando datos, por favor espere...</span>
  </div>

  <!-- Datos del Cliente -->
  <div *ngIf="resultados.length > 0" class="bg-gray-50 dark:bg-gray-800 p-6 rounded-lg shadow mb-6">
    <h2 class="text-xl font-semibold text-gray-900 dark:text-white mb-4">Datos del Cliente</h2>
    <div class="grid grid-cols-1 sm:grid-cols-3 gap-4 text-sm text-gray-700 dark:text-gray-300">
      <div>
        <span class="font-medium">Nombre:</span>
        <!-- <span class="ml-2 text-gray-900 dark:text-white">{{ resultados[0].snombrE_COMPLETO }}</span> -->
        <span class="ml-2">{{ clienteDatos.nombre }}</span>

      </div>
      <div>
        <span class="font-medium">Doc Identidad:</span>
        <!-- <span class="ml-2 text-gray-900 dark:text-white">{{ resultados[0].snrO_DOCUMENTO_ASEGURADO }}</span> -->
        <span class="ml-2">{{ clienteDatos.doc }}</span>

      </div>
      <div>
        <span class="font-medium">Tipo Documento:</span>
        <!-- <span class="ml-2 text-gray-900 dark:text-white">{{ resultados[0].stipO_DOCUMENTO_ASEGURADO }}</span> -->
        <span class="ml-2">{{ clienteDatos.tipo }}</span>

      </div>
    </div>
  </div>

  <!-- Tabla -->

  <div *ngIf="resultados.length > 0" class="mt-8">
    <div *ngFor="let grupo of groupedResultados | keyvalue"
      class="mb-4 border border-gray-200 dark:border-gray-700 rounded-lg">

      <!-- Cabecera del grupo -->
      <button (click)="toggleCollapse(grupo.key)"
        class="w-full flex justify-between items-center px-4 py-3 bg-blue-100 dark:bg-blue-800 text-blue-900 dark:text-blue-100 font-semibold text-left">
        <span>{{ grupo.key }} ({{ grupo.value.length }})</span>
        <span class="text-lg">{{ isCollapsed(grupo.key) ? '+' : '−' }}</span>
      </button>

      <!-- Contenido del grupo (tabla con scroll horizontal) -->
      <div *ngIf="!isCollapsed(grupo.key)" class="w-full">
        <div class="overflow-x-auto">
          <table class="min-w-[1200px] w-max divide-y divide-gray-200 dark:divide-gray-700 mb-4 table-auto">
            <thead class="sticky top-0 z-10 bg-gray-100 dark:bg-gray-800">
              <tr>
                <th class="px-4 py-2 text-xs font-medium text-gray-500 dark:text-gray-300 uppercase">Id Producto</th>
                <th class="px-4 py-2 text-xs font-medium text-gray-500 dark:text-gray-300 uppercase">Número de Póliza
                </th>
                <th class="px-4 py-2 text-xs font-medium text-gray-500 dark:text-gray-300 uppercase">Operation PK</th>
                <th class="px-4 py-2 text-xs font-medium text-gray-500 dark:text-gray-300 uppercase">Número Crédito</th>
                <th class="px-4 py-2 text-xs font-medium text-gray-500 dark:text-gray-300 uppercase">Inicio Cobertura
                </th>
                <th class="px-4 py-2 text-xs font-medium text-gray-500 dark:text-gray-300 uppercase">Fin Cobertura</th>
                <th class="px-4 py-2 text-xs font-medium text-gray-500 dark:text-gray-300 uppercase text-right">Monto
                  Asegurado</th>
                <th class="px-4 py-2 text-xs font-medium text-gray-500 dark:text-gray-300 uppercase text-right">Prima
                </th>
                <th class="px-4 py-2 text-xs font-medium text-gray-500 dark:text-gray-300 uppercase">Moneda</th>
                <th class="px-4 py-2 text-xs font-medium text-gray-500 dark:text-gray-300 uppercase">Fecha Inicio Póliza
                </th>
                <th class="px-4 py-2 text-xs font-medium text-gray-500 dark:text-gray-300 uppercase">Fecha Fin Póliza
                </th>
                <th class="px-4 py-2 text-xs font-medium text-gray-500 dark:text-gray-300 uppercase">Fecha Desembolso
                  Crédito</th>
                <th class="px-4 py-2 text-xs font-medium text-gray-500 dark:text-gray-300 uppercase">Fecha Vencimiento
                  Crédito</th>
                <th class="px-4 py-2 text-xs font-medium text-gray-500 dark:text-gray-300 uppercase">Fecha Proceso</th>
                <th class="px-4 py-2 text-xs font-medium text-gray-500 dark:text-gray-300 uppercase">Contratante</th>
                <th class="px-4 py-2 text-xs font-medium text-gray-500 dark:text-gray-300 uppercase">Canal</th>
                <th class="px-4 py-2 text-xs font-medium text-gray-500 dark:text-gray-300 uppercase">Canal Vinculado</th>
                <th class="px-4 py-2 text-xs font-medium text-gray-500 dark:text-gray-300 uppercase">Estado Póliza</th>
                <th class="px-4 py-2 text-xs font-medium text-gray-500 dark:text-gray-300 uppercase">Evento</th>
                <th class="px-4 py-2 text-xs font-medium text-gray-500 dark:text-gray-300 uppercase">Estado UR</th>

              </tr>
            </thead>
            <tbody class="bg-white dark:bg-gray-900 divide-y divide-gray-200 dark:divide-gray-700">
              <tr *ngFor="let item of grupo.value">
                <td class="px-4 py-2 text-sm text-gray-800 dark:text-gray-200">{{ item.niD_PRODUCTO }}</td>
                <td class="px-4 py-2 text-sm text-gray-800 dark:text-gray-200">{{ item.snumerO_POLIZA }}</td>
                <td class="px-4 py-2 text-sm text-gray-800 dark:text-gray-200">{{ item.operationpk }}</td>
                <td class="px-4 py-2 text-sm text-gray-800 dark:text-gray-200">{{ item.snumerO_CREDITO }}</td>
                <td class="px-4 py-2 text-sm text-gray-800 dark:text-gray-200">{{ item.siniciO_CIBERTURA }}</td>
                <td class="px-4 py-2 text-sm text-gray-800 dark:text-gray-200">{{ item.sfiN_COBERTURA }}</td>
                <td class="px-4 py-2 text-sm text-gray-800 dark:text-gray-200 text-right">{{ item.nmontO_ASEGURADO |
                  number:'1.2-2' }}</td>
                <td class="px-4 py-2 text-sm text-gray-800 dark:text-gray-200 text-right">{{ item.nprima |
                  number:'1.2-2' }}</td>
                <td class="px-4 py-2 text-sm text-gray-800 dark:text-gray-200">{{ item.smoneda }}</td>
                <td class="px-4 py-2 text-sm text-gray-800 dark:text-gray-200">{{ item.inI_POLIZA }}</td>
                <td class="px-4 py-2 text-sm text-gray-800 dark:text-gray-200">{{ item.fiN_POLIZA || '-' }}</td>
                <td class="px-4 py-2 text-sm text-gray-800 dark:text-gray-200">{{ item.sfechA_DESEMBOLSO_CREDITO || '-'
                  }}</td>
                <td class="px-4 py-2 text-sm text-gray-800 dark:text-gray-200">{{ item.sfechA_VENCIMIENTO_CREDITO || '-'
                  }}</td>
                <td class="px-4 py-2 text-sm text-gray-800 dark:text-gray-200">{{ item.sfechA_PROCESO }}</td>
                <td class="px-4 py-2 text-sm text-gray-800 dark:text-gray-200">{{ item.contratante || '-' }}</td>
                <td class="px-4 py-2 text-sm text-gray-800 dark:text-gray-200">{{ item.canal || '-' }}</td>
                <td class="px-4 py-2 text-sm text-gray-800 dark:text-gray-200">{{ item.eS_CANAL_VINCULADO || '-' }}</td>
                <td class="px-4 py-2 text-sm text-gray-800 dark:text-gray-200">{{ item.estadO_POLIZA || '-' }}</td>
                <td class="px-4 py-2 text-sm text-gray-800 dark:text-gray-200">{{ item.eventO_POLIZA || '-' }}</td>
                <td class="px-4 py-2 text-sm text-gray-800 dark:text-gray-200">{{ item.estadO_UR || '-' }}</td>

              </tr>
            </tbody>
          </table>
        </div>
      </div>

    </div>
  </div>




  <div *ngIf="resultado" class="mt-6 text-green-600 dark:text-green-400">
     {{ resultado }}
  </div>
</div>